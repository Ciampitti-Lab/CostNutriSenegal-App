---
title: "CosNutri Senegal App"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    css: css/styles.css
    logo: www/Logo.png
runtime: shiny
resource_files:
- data/Data_for_Kansas_DIOURBEL.xlsx
- data/Data_for_Kansas_FATICK.xlsx
- data/Data_for_Kansas_KAFFRINE.xlsx
- data/Data_for_Kansas_KAOLACK.xlsx
- data/Data_for_Kansas_KOLDA.xlsx
- data/Data_for_Kansas_THIES.xlsx
- shapefiles/zonal_stats.dbf
- shapefiles/zonal_stats.prj
- shapefiles/zonal_stats.shx
---

```{r setup, include=FALSE}
# Libraries ----

## 1. App -----
library(shiny)
library(flexdashboard)
library(shinydashboard)
library(shinythemes)
library(shinyWidgets)

## 2. Data Usage -----
library(tidyverse)

## 3. Design Help -----
library(tippy)

## 4. Map -----
library(leaflet)
library(sf)

## 5. Data import ----
library(openxlsx)

## 6. Graph ----
library(plotly)
library(ggplot2)
library(scales)

# Data upload ---------

## 1. Cost ----
productionCost <- read.csv("data/pearl_millet_management_costs.csv", sep=",", dec=".")

## 2. Map -----
Sys.setenv(SHAPE_RESTORE_SHX="YES")
districts <- st_read("shapefiles/zonal_stats.shp", stringsAsFactors=FALSE, quiet=TRUE)

## 3. Data for cards ----
dataFCards <- read.csv("data/Alternative_Scenarios_Card.csv", sep=",", dec=".")

## 4. Units ----
units <- read.csv("data/Units.csv", sep = ",", dec = ".")

## 5. Planting date labels ----
labels <- read.csv("data/filteredPlantingDates.csv", sep = ",", dec = ".")

# Filtering functions import ----
source(file = "functions.R")

# Font awesome importation ----
tags$script(src="https://kit.fontawesome.com/e66b2723d1.js")
tags$head( tags$style(HTML(".fa{font-size: 10px;}")))

```


Visualization
============================

Inputs {.sidebar data-width=350}
----------------------------
```{r}

# Select for Districts -----
shinyWidgets::pickerInput(inputId = "districtSelection",
                          label = h4("Select a District: "),
                          choices = c("Diourbel" = "DIOURBEL", 
                                      "Fatick" = "FATICK",
                                      "Kaffrine" = "KAFFRINE",
                                      "Kaolack" = "KAOLACK",
                                      "Kolda" = "KOLDA",
                                      "Thies" = "THIES"),
                          multiple = FALSE
        )

# Generating Map ----
output$districtMap <- renderLeaflet({

    map_rendering(districts, input$districtSelection)

})

# Showing the map ----
leafletOutput("districtMap", height = 225)

hr()

# Radio for precipitation or alternative -----
shiny::radioButtons(inputId = "precipitationOrAlternative",
                    label = h4("Analysis by:"),
                    choices = c("Alternative managements" = "alternativeManagements",
                                "Weather based"  = "precipitation")
                    )

# Appears when selected alternative managements ------

output$pdPickerInput <- renderUI({
  pdLabel <- label_filter(data = labels,
                          district = input$districtSelection)
  
  shinyWidgets::pickerInput(inputId = "plantingDate",
                          label = h4("Select a planting date:"),
                          choices = pdLabel,
                          multiple = FALSE
        )
  
  
})

conditionalPanel(
  condition = "input.precipitationOrAlternative == 'alternativeManagements'",
  hr(),
  uiOutput(outputId = "pdPickerInput"),
  shinyWidgets::pickerInput(inputId = "plantingDensity",
                          label = h4("Select a planting density:"),
                          choices = c("1.1 plant/m2" = 1.1,
                                      "3.3 plants/m2" = 3.3,
                                      "6.6 plants/m2" = 6.6),
                          multiple = FALSE
        ),
  sliderInput(inputId = "nAmount",
              label = h4("Amount of nitrogen fertilizer (kg/ha):"),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = "")
)

conditionalPanel(
  condition = "input.precipitationOrAlternative == 'precipitation'",
  hr(),
  sliderInput(inputId = "precipitationAmount",
              label = h4("Precipitation amount:"),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = ""),
  shinyWidgets::pickerInput(inputId = "plantingDensity",
                          label = h4("Select a planting density:"),
                          choices = c("1.1 plant/m2" = 1.1,
                                      "3.3 plants/m2" = 3.3,
                                      "6.6 plants/m2" = 6.6),
                          multiple = FALSE
        ),
  sliderInput(inputId = "nAmount",
              label = h4("Amount of nitrogen fertilizer (kg/ha):"),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = "")
)

```

Box Chart
----------------------------
### Scenarios chart

<center>
```{r}
# Select for Variable -----
shinyWidgets::pickerInput(inputId = "variableSelection",
                          label = h5("Select a variable to be plotted: "),
                          choices = c("Net cash Income" = "NCFI", 
                                      "Calories" = "KCal",
                                      "Protein" = "GProtien",
                                      "Fat" = "GFat",
                                      "Calcium" = "GCal",
                                      "Iron" = "GIron",
                                      "Vitamin A" = "GVitA",
                                      "Production" = "production"),
                          multiple = FALSE,
                          inline = TRUE,
                          width = "fit"
        )
```
</center>

```{r}

output$boxPlot <- renderPlotly({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    
    
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements"){
    
    boxPlot <- graph_filtering(district = input$districtSelection,
                              pd = input$plantingDate,
                              pp = input$plantingDensity,
                              n = input$nAmount,
                              acronym = input$variableSelection,
                              unitsTable = units)
    
  }
  
  ggplotly(boxPlot)
  
})

div(
  id = "plot",
  style = "height: 350px",
  plotlyOutput("boxPlot")
)


```

Checkbox & Legends{data-height=180}
----------------------------

### Year selection and nutritional legend
<center>
```{r}
# Select Alternative Scenarios ----
shinyWidgets::radioGroupButtons(inputId = "yearSelection",
                                  label = "Select a year to show on the cards",
                                  choices = c("2016" = 1,
                                              "2017" = 2,
                                              "2018" = 3,
                                              "2019" = 4,
                                              "2020" = 5
                                              ),
                                  status = "primary"
  )
```
</center>
```{r}
hr()
div(
  # Legend for nutrition ----
  tags$img(src = "www/CardsLegend1.png",
           id = "cardLegend")
)
```

Cards 1
----------------------------

### Seed Cost
```{r}

# Value box of Seed cost ----------
seedCost <- reactive({
  
  productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
  cost = productionCost$seed_cost
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(seedCost()), "USD"))),
                          caption = h4("Seed cost"),
                          color = "#70aec3",
                          icon = "fa-dollar-sign")
})

```

### Nitrogen Cost
```{r}

# Value box of Nitrogen cost ----------
NCost <- reactive({
  
  productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
  cost = productionCost$nitrogen_cost
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(NCost()), "USD"))),
                          caption = h4("Nitrogen fertilizer cost"),
                          color = "#70aec3",
                          icon = "fa-dollar-sign")
})

```

### Cal per person per day
```{r}

# Value box of KCal per person ----------
KCalperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "KCal",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "KCal",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(KCalperperson()), "Cal"))),
                          caption = h4("Cal per person per day"),
                          color = ifelse(round(KCalperperson(), digits=1) > 2306.4 , "success", "danger"),
                          icon = "fa-utensils")
})

```


### Protein per person per day
```{r}

# Value box of Protein per person ----------
Proteinperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GProtien",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GProtien",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Proteinperperson()), "grams"))),
                          caption = h4("Protein per person per day"),
                          color = ifelse(round(Proteinperperson(), digits=1) > 52.1 , "success", "danger"),
                          icon = "fa-utensils")
})

```

### Fat per person per day
```{r}

# Value box of Fat per person ----------
Fatperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GFat",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GFat",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Fatperperson()), "grams"))),
                          caption = h4("Fat per person per day"),
                          color = ifelse(round(Fatperperson(), digits=1) > 73.7 , "success", "danger"),
                          icon = "fa-utensils")
})

```

Cards 2
----------------------------

### Total Cost
```{r}

# Value box of Total production cost ----------
totalCost <- reactive({
  
  productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
  cost = productionCost$total_cost
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(totalCost()), "USD"))),
                          caption = h4("Total production cost"),
                          color = "#70aec3",
                          icon = "fa-dollar-sign")
})
```

### Net Cash Income
```{r, echo=FALSE}

# Value box of Net Cash Income ----------
netCashIncome <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "NCFI",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "NCFI",
                           year = input$yearSelection)
    
  }
  
  value <- cost/(100*607.77)
  return(value)
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2(paste(round(netCashIncome()), "USD")),
                          caption = paste("<h4>Net cash income <small style = 'color:white'>(x100)</small></h4>",
                                          sep = ""),
                          color = "#70aec3",
                          icon = "fa-dollar-sign")
})

```

### Calcium per person per day
```{r}

# Value box of Calcium per person ----------
Calciumperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GCal",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GCal",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Calciumperperson()), "mg"))),
                          caption = h4("Calcium per person per day"),
                          color = ifelse(round(Calciumperperson(), digits=1) > 1446.7 , "success", "danger"),
                          icon = "fa-utensils")
})

```

### Iron per person per day
```{r}

# Value box of Iron per person ----------
Ironperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GIron",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GIron",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Ironperperson()), "mg"))),
                          caption = h4("Iron per person per day"),
                          color = ifelse(round(Ironperperson(), digits=2) > 13.7 , "success", "danger"),
                          icon = "fa-utensils")
})

```

### Vit A per person per day
```{r}
# Value box of Vitamin A per person ----------
VitAperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GVitA",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GVitA",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(VitAperperson(), digits=3), "mg"))),
                          caption = h4("Vitamin A per person per day"),
                          color = ifelse(round(VitAperperson(), digits=3) > 0.868 , "success", "danger"),
                          icon = "fa-utensils"
                          )
})
```
