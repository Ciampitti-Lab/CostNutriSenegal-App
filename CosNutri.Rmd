---
title: "CosNutri Senegal App"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: css/styles.css
    logo: www/Logo.png
runtime: shiny
---

```{r setup, include=FALSE}
# Libraries ----

## 1. App -----
library(shiny)
library(flexdashboard)
library(shinydashboard)
library(shinythemes)
library(shinyWidgets)

## 2. Data Usage -----
library(tidyverse)

## 3. Design Help -----
library(tippy)

## 4. Map -----
library(leaflet)
library(sf)

## 5. Data import ----
library(openxlsx)

library(DT)

# Data upload ---------

## 1. Cost ----
productionCost <- read.csv("data/pearl_millet_management_costs.csv", sep=",", dec=".")

## 2. Map -----
Sys.setenv(SHAPE_RESTORE_SHX="YES")
districts <- st_read("shapefiles/zonal_stats.shp", stringsAsFactors=FALSE, quiet=TRUE)

## 3. Data for cards ----
dataFCards <- read.csv("data/Alternative_Scenarios_Card.csv", sep=",", dec=".")

# Filtering functions import ----
source(file = "functions.R")

```


Visualization
============================

Column {.sidebar data-width=350}
----------------------------
```{r}
# Select for Districts -----
shinyWidgets::pickerInput(inputId = "districtSelection",
                          label = h4("Select a District: "),
                          choices = c("Diourbel" = "DIOURBEL", 
                                      "Fatick" = "FATICK",
                                      "Kaffrine" = "KAFFRINE",
                                      "Kaolack" = "KAOLACK",
                                      "Kolda" = "KOLDA",
                                      "Thies" = "THIES"),
                          multiple = FALSE
        )

# Radio for baseline or alternative -----
shiny::radioButtons(inputId = "baselineOrAlternative",
                    label = tippy("Select the management: (Hover me!)",
                                  tooltip = paste("<p>The baseline management is compound of: <p>",
                                                  "<p>Planting date = 1<p>",
                                                  "<p>Planting density = 1.1<p>",
                                                  "<p>Nitrogen fertilzer amount = 30<p>",
                                                  sep =""),
                                  placement = "top-start",
                                  arrow = TRUE,
                                  animation = "scale",
                                  theme = "light"),
                    choices = c("Baseline"  = "baseline",
                                "Alternative managements" = "alternativeManagements")
                    )

# Appears when selected alternative managements ------

conditionalPanel(
  condition = "input.baselineOrAlternative == 'alternativeManagements'",
  hr(),
  shinyWidgets::pickerInput(inputId = "plantingDate",
                          label = h4("Select a planting date: "),
                          choices = c(1, 2, 3),
                          multiple = FALSE
        ),
  shinyWidgets::pickerInput(inputId = "plantingDensity",
                          label = h4("Select a planting density: "),
                          choices = c(1.1, 3.3, 6.6),
                          multiple = FALSE
        ),
  sliderInput(inputId = "nAmount",
              label = h4("Amount of nitrogen fertilizer: "),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = "")
)

# Select Alternative Scenarios ----
hr()

shinyWidgets::pickerInput(inputId = "scenarioSelection",
                          label = h4("Select an alternative scenario: "),
                          choices = c(1, 2, 3, 4, 5),
                          multiple = FALSE
        )
```

Row {data-height=150}
----------------------------
### Seed Cost
```{r}

# Value box of Seed cost ----------
seedCost <- reactive({
  
  if(input$baselineOrAlternative == "baseline"){
    cost = 1.4839
  }
  
  else if(input$baselineOrAlternative == "alternativeManagements") {
    
    productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
    cost = productionCost$seed_cost
    
  }
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(seedCost(), digits=2), "?"))),
                          caption = paste("<br>",
                                          "<h4>Seed cost</h4>",
                                          sep =""),
                          icon = "fa-dollar-sign",
                          color = ifelse(seedCost() == 1.4839 , "green", ifelse(seedCost() == 4.4517, "#d6d304", "red")))
})

```

### Nitrogen Cost
```{r}

# Value box of Nitrogen cost ----------
NCost <- reactive({
  
  if(input$baselineOrAlternative == "baseline"){
    cost = 31.1839
  }
  
  else if(input$baselineOrAlternative == "alternativeManagements") {
    
    productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
    cost = productionCost$nitrogen_cost
    
  }
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(NCost(), digits=2), "?"))),
                          caption = paste("<br>",
                                          "<h4>Nitrogen fertilizer cost</h4>",
                                          sep =""),
                          icon = "fa-dollar-sign",
                          color = ifelse(NCost() < 50, "green", "red"))
})

```

### Total Cost
```{r}

# Value box of Total production cost ----------
totalCost <- reactive({
  
  if(input$baselineOrAlternative == "baseline"){
    cost = 31.1839
  }
  
  else if(input$baselineOrAlternative == "alternativeManagements") {
    
    productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
    cost = productionCost$total_cost
    
  }
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(totalCost(), digits=2), "?"))),
                          caption = paste("<br>",
                                          "<h4>Total production cost</h4>",
                                          sep =""),
                          icon = "fa-dollar-sign",
                          color = ifelse(totalCost() < 50, "green", "red"))
})
```

### Net Cash Income
```{r}

```

### Kcal per person per day
```{r}

```

Row {data-height=150}
----------------------------

### Protein per person per day
```{r}

```

### Fat per person per day
```{r}

```

### Calcium per person per day
```{r}

```

### Iron per person per day
```{r}

```

### Cost/Kcal ratio
```{r}
gauge(round(100*(1.0*20)/50,2),0,100, symbol = '%', label= "Full Cabin Match: Tile 1", gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)))
```

Row
----------------------------
### Scenarios chart
```{r}



```

### District selected

```{r}
# Filtering from user input -----
selectDistrict <- reactive({

  districtSelected <- districts %>%
    dplyr::filter(DISTRICT == input$districtSelection)

  districtSelected

})

# Generating Map ----
output$districtMap <- renderLeaflet({

    leaflet(width = 200, height = 300) %>%
          addTiles() %>%
          addPolygons( data = districts,
                       weight = 1,
                       smoothFactor = 0.2,
                       fillOpacity = 0.2,
                       color = "black",
                       highlight = highlightOptions(
                             weight = 5,
                             color = "#666666",
                             fillOpacity = 0.25,
                             bringToFront = TRUE
                           ),
                       label = districts$DISTRICT
            ) %>%
          addPolygons( data = selectDistrict(),
                       weight = 1,
                       smoothFactor = 1,
                       fillOpacity = 1,
                       color = "#1c5f7e",
                        highlight = highlightOptions(
                             weight = 5,
                             color = "#666666",
                             fillOpacity = 0.5,
                             bringToFront = TRUE
                           )
            )

})

# Showing the map ----
leafletOutput("districtMap")
```