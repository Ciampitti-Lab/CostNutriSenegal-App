---
title: "CosNutri Senegal App"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: css/styles.css
    logo: www/Logo.png
runtime: shiny
resource_files:
- data/Data_for_Kansas_DIOURBEL.xlsx
- data/Data_for_Kansas_FATICK.xlsx
- data/Data_for_Kansas_KAFFRINE.xlsx
- data/Data_for_Kansas_KAOLACK.xlsx
- data/Data_for_Kansas_KOLDA.xlsx
- data/Data_for_Kansas_THIES.xlsx
---

```{r setup, include=FALSE}
# Libraries ----

## 1. App -----
library(shiny)
library(flexdashboard)
library(shinydashboard)
library(shinythemes)
library(shinyWidgets)

## 2. Data Usage -----
library(tidyverse)

## 3. Design Help -----
library(tippy)

## 4. Map -----
library(leaflet)
library(sf)

## 5. Data import ----
library(openxlsx)

## 6. Graph ----
library(plotly)
library(ggplot2)

# Data upload ---------

## 1. Cost ----
productionCost <- read.csv("data/pearl_millet_management_costs.csv", sep=",", dec=".")

## 2. Map -----
Sys.setenv(SHAPE_RESTORE_SHX="YES")
districts <- st_read("shapefiles/zonal_stats.shp", stringsAsFactors=FALSE, quiet=TRUE)

## 3. Data for cards ----
dataFCards <- read.csv("data/Alternative_Scenarios_Card.csv", sep=",", dec=".")

## 4. Units
units <- read.csv("data/Units.csv", sep = ",", dec = ".")

# Filtering functions import ----
source(file = "functions.R")

# Font awesome importation ----
tags$script(src="https://kit.fontawesome.com/e66b2723d1.js")

```


Visualization
============================

Inputs {.sidebar data-width=350}
----------------------------
```{r}

# Select for Districts -----
shinyWidgets::pickerInput(inputId = "districtSelection",
                          label = h4("Select a District: "),
                          choices = c("Diourbel" = "DIOURBEL", 
                                      "Fatick" = "FATICK",
                                      "Kaffrine" = "KAFFRINE",
                                      "Kaolack" = "KAOLACK",
                                      "Kolda" = "KOLDA",
                                      "Thies" = "THIES"),
                          multiple = FALSE
        )

# Generating Map ----
output$districtMap <- renderLeaflet({

    map_rendering(districts, input$districtSelection)

})

# Showing the map ----
leafletOutput("districtMap", height = 250)

hr()

# Radio for precipitation or alternative -----
shiny::radioButtons(inputId = "precipitationOrAlternative",
                    label = h4("Analysis by:"),
                    choices = c("Alternative managements" = "alternativeManagements",
                                "Precipitation"  = "precipitation")
                    )

# Appears when selected alternative managements ------

conditionalPanel(
  condition = "input.precipitationOrAlternative == 'alternativeManagements'",
  hr(),
  shinyWidgets::pickerInput(inputId = "plantingDate",
                          label = h4("Select a planting date:"),
                          choices = c(1, 2, 3),
                          multiple = FALSE
        ),
  shinyWidgets::pickerInput(inputId = "plantingDensity",
                          label = h4("Select a planting density:"),
                          choices = c("1.1 plant/m2" = 1.1,
                                      "3.3 plants/m2" = 3.3,
                                      "6.6 plants/m2" = 6.6),
                          multiple = FALSE
        ),
  sliderInput(inputId = "nAmount",
              label = h4("Amount of nitrogen fertilizer (kg/ha):"),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = "")
)

conditionalPanel(
  condition = "input.precipitationOrAlternative == 'precipitation'",
  hr(),
  sliderInput(inputId = "precipitationAmount",
              label = h4("Precipitation amount:"),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = ""),
  shinyWidgets::pickerInput(inputId = "plantingDensity",
                          label = h4("Select a planting density:"),
                          choices = c("1.1 plant/m2" = 1.1,
                                      "3.3 plants/m2" = 3.3,
                                      "6.6 plants/m2" = 6.6),
                          multiple = FALSE
        ),
  sliderInput(inputId = "nAmount",
              label = h4("Amount of nitrogen fertilizer (kg/ha):"),
              min = 0,
              max = 100,
              value = 60,
              step = 20,
              sep = "")
)

```

Box Chart {data-height = 450}
----------------------------
### Scenarios chart

<center>
```{r}
# Select for Variable -----
shinyWidgets::pickerInput(inputId = "variableSelection",
                          label = h5("Select a variable to be plotted: "),
                          choices = c("Net cash Income" = "NCFI", 
                                      "Kilocalories" = "KCal",
                                      "Protein" = "GProtien",
                                      "Fat" = "GFat",
                                      "Calcium" = "GCal",
                                      "Iron" = "GIron",
                                      "Vitamin A" = "GVitA"),
                          multiple = FALSE,
                          inline = TRUE,
                          width = "fit"
        )
```
</center>

```{r}

output$boxPlot <- renderPlotly({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    boxPlot <- graph_filtering(district = input$districtSelection,
                              precipitation = TRUE,
                              acronym = input$variableSelection)
    
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements"){
    
    boxPlot <- graph_filtering(district = input$districtSelection,
                              precipitation = FALSE,
                              pd = input$plantingDate,
                              pp = input$plantingDensity,
                              n = input$nAmount,
                              acronym = input$variableSelection,
                              unitsTable = units)
    
  }
  
  ggplotly(boxPlot, height = 300)
  
})

div(
  class = "container",
  id = "plot",
  style = "height: 350px;",
  plotlyOutput("boxPlot")
)


```

Checkbox {data-height=100}
----------------------------

### Year selection
<center>
```{r}
# Select Alternative Scenarios ----
shinyWidgets::radioGroupButtons(inputId = "yearSelection",
                                label = "Select a year to show on cards",
                                choices = c("2016" = 1,
                                            "2017" = 2,
                                            "2018" = 3,
                                            "2019" = 4,
                                            "2020" = 5
                                            ),
                                status = "primary"
)
```
</center>

Cards 1 {data-height=150}
----------------------------

### Seed Cost
```{r}

# Value box of Seed cost ----------
seedCost <- reactive({
  
  productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
  cost = productionCost$seed_cost
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(seedCost()), "USD"))),
                          caption = paste("<h4>Seed cost</h4>",
                                          sep =""),
                          color = ifelse(seedCost() == 1.4839 , "success",
                                         ifelse(seedCost() == 4.4517, "warning",
                                                "danger")),
                          icon = "fa-dollar-sign")
})

```

### Nitrogen Cost
```{r}

# Value box of Nitrogen cost ----------
NCost <- reactive({
  
  productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
  cost = productionCost$nitrogen_cost
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(NCost()), "USD"))),
                          caption = paste("<h4>Nitrogen fertilizer cost</h4>",
                                          sep =""),
                          color = ifelse(NCost() < 50, "success", "danger"),
                          icon = "fa-dollar-sign")
})

```

### Cal per person per day
```{r}

# Value box of KCal per person ----------
KCalperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "KCal",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "KCal",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(KCalperperson()), "Cal"))),
                          caption = paste("<h4>Cal per person per day</h4>",
                                          sep =""),
                          color = ifelse(round(KCalperperson(), digits=1) > 2303.6 , "success",
                                         ifelse(round(KCalperperson(), digits=1) < 1740.5, "danger",
                                                "warning")),
                          icon = "fa-utensils")
})

```


### Protein per person per day
```{r}

# Value box of Protein per person ----------
Proteinperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GProtien",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GProtien",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Proteinperperson()), "grams"))),
                          caption = paste("<h4>Protein per person per day</h4>",
                                          sep =""),
                          color = ifelse(round(Proteinperperson(), digits=1) > 76.8 , "success",
                                         ifelse(round(Proteinperperson(), digits=1) < 56.2, "danger",
                                                "warning")),
                          icon = "fa-utensils")
})

```

### Fat per person per day
```{r}

# Value box of Fat per person ----------
Fatperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GFat",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GFat",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Fatperperson()), "grams"))),
                          caption = paste("<h4>Fat per person per day</h4>",
                                          sep =""),
                          color = ifelse(round(Fatperperson(), digits=1) > 107.9 , "success",
                                         ifelse(round(Fatperperson(), digits=1) < 80.4, "danger",
                                                "warning")),
                          icon = "fa-utensils")
})

```

Cards 20{data-height=150}
----------------------------

### Total Cost
```{r}

# Value box of Total production cost ----------
totalCost <- reactive({
  
  productionCost <- productionCost %>%
      dplyr::filter(planting_date == input$plantingDate,
                    plantig_density == input$plantingDensity,
                    nitrogen_fertilizer == input$nAmount)
    
  cost = productionCost$total_cost
  
  cost
  
})


flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h1((paste(round(totalCost()), "USD"))),
                          caption = paste("<h4>Total production cost</h4>",
                                          sep =""),
                          color = ifelse(totalCost() < 50, "success", "danger"),
                          icon = "fa-dollar-sign")
})
```

### Net Cash Income
```{r, echo=FALSE}

# Value box of Net Cash Income ----------
netCashIncome <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "NCFI",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "NCFI",
                           year = input$yearSelection)
    
  }
  
  cost <- cost/(100*607.77)
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2(paste(round(netCashIncome()), "USD")),
                          caption = paste("<h4>Net cash income <small style = 'color:white'>(x100)</small></h4>",
                                          sep =""),
                          color = ifelse(round(netCashIncome(), digits=1) > 11390401.3 , "success",
                                         ifelse(round(netCashIncome(), digits=1) < 5178833.7, "danger",
                                                "warning")),
                          icon = "fa-dollar-sign")
})

```

### Calcium per person per day
```{r}

# Value box of Calcium per person ----------
Calciumperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GCal",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GCal",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Calciumperperson()), "mg"))),
                          caption = paste("<h4>Calcium per person per day</h4>",
                                          sep =""),
                          color = ifelse(round(Calciumperperson(), digits=1) > 366.8 , "success",
                                         ifelse(round(Calciumperperson(), digits=1) < 204.3, "danger",
                                                "warning")),
                          icon = "fa-utensils")
})

```

### Iron per person per day
```{r}

# Value box of Iron per person ----------
Ironperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GIron",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GIron",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(Ironperperson()), "mg"))),
                          caption = paste("<h4>Iron per person per day</h4>",
                                          sep =""),
                          color = ifelse(round(Ironperperson(), digits=2) > 11.8 , "success",
                                         ifelse(round(Ironperperson(), digits=2) < 7.96, "danger",
                                                "warning")),
                          icon = "fa-utensils")
})

```

### Vit A per person per day
```{r}
# Value box of Vitamin A per person ----------
VitAperperson <- reactive({
  
  if(input$precipitationOrAlternative == "precipitation"){
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = TRUE,
                           acronym = "GVitA",
                           year = input$yearSelection)
  }
  
  else if(input$precipitationOrAlternative == "alternativeManagements") {
    
    cost <- card_filtering(dataBase = dataFCards,
                           district = input$districtSelection,
                           precipitation = FALSE,
                           pd = input$plantingDate,
                           pp = input$plantingDensity,
                           n = input$nAmount,
                           acronym = "GVitA",
                           year = input$yearSelection)
    
  }
  
  cost
  
})

flexdashboard::renderValueBox({

  flexdashboard::valueBox(value = h2((paste(round(VitAperperson(), digits=3), "mg"))),
                          caption = paste("<h4>Vitamin A per person per day</h4>",
                                          sep =""),
                          color = ifelse(round(VitAperperson(), digits=3) > 0.103 , "success",
                                         ifelse(round(VitAperperson(), digits=3) < 0.041, "danger",
                                                "warning")),
                          icon = "fa-utensils"
                          )
})
```
